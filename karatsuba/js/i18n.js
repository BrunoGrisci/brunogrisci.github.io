(function () {
  const messages = {
    en: {
      app_title: 'Karatsuba Multiplication Visualizer',
      app_subtitle: 'Compare classroom multiplication and Karatsuba step by step.',
      controls_title: 'Controls',
      mult_table_open: 'Open multiplication table (0 to 9)',
      mult_table_title: 'Multiplication table (0 to 9)',
      help_open: 'Open quick help',
      help_title: 'How to use this visualizer',
      help_intro: 'This tool compares classroom multiplication and Karatsuba multiplication step by step.',
      help_use_title: 'How to use:',
      help_use_1: 'Enter two integers (they are padded automatically to power-of-two lengths when needed).',
      help_use_2: 'Use Run step, Auto run, or Run full to control execution.',
      help_use_3: 'Switch tabs to compare algorithms; counters show one-digit multiplications and sums so far.',
      help_use_4: 'Use panel toggles to free space and inspect the decomposition tree.',
      close_btn: 'Close',
      toggle_controls_hide: 'Collapse controls panel',
      toggle_controls_show: 'Expand controls panel',
      toggle_code_hide: 'Collapse algorithm and log panel',
      toggle_code_show: 'Expand algorithm and log panel',
      input_x_label: 'First number (x)',
      input_y_label: 'Second number (y)',
      random_length_label: 'Random length',
      random_btn: 'Random',
      prepare_btn: 'Prepare',
      run_step_btn: 'Run step',
      auto_run_btn: 'Auto run',
      run_full_btn: 'Run full',
      speed_label: 'Speed',
      reset_btn: 'Reset steps',
      metric_total: 'Total operations (mul + sum)',
      metric_mul_small: 'Multiplications',
      metric_add_small: 'Sums',
      metric_step: 'Current step',
      derivation_depth_label: 'Derivation depth',
      derivation_depth_value: '{current} / {total}',
      tab_classroom: 'Classroom algorithm',
      tab_karatsuba: 'Karatsuba algorithm',
      tab_comparison: 'Operations comparison',
      digits_grid_title: 'Digits grid',
      powers_title: 'Rewriting as powers of 10',
      derivation_title: 'Derivation',
      karatsuba_identity_title: 'Karatsuba identity',
      karatsuba_tree_title: 'Recursive decomposition',
      dropped_title: 'Dropped direct multiplications',
      code_title: 'Algorithm code',
      log_title: 'Step log',
      footer_repo: 'Project repository:',
      footer_license: 'MIT License',
      footer_references_link: 'References',
      footer_ai: 'Developed with assistance from GPT-5 Codex.',
      references_title: 'References',
      references_main_heading: 'Main references',
      references_main_1_author: 'Roughgarden, Tim.',
      references_main_1_title: 'Algorithms Illuminated: Part 1: The Basics.',
      references_main_1_pub: 'Soundlikeyourself Publishing, 2017.',
      references_main_2_author: 'Kleinberg, Jon; Tardos, Éva.',
      references_main_2_title: 'Algorithm Design.',
      references_main_2_pub: 'Addison-Wesley (Pearson), 2005.',
      references_other_heading: 'Other references',
      references_other_1_prefix: 'Youtube - ',
      references_other_1_title: 'The Fastest Multiplication Algorithm',
      references_other_2_prefix: 'Youtube - ',
      references_other_2_title: 'How a Russian student invented a faster multiplication method',
      references_other_3_prefix: 'Wikipedia - ',
      references_other_3_title: 'Ancient Egyptian multiplication',
      references_see_more_heading: 'See more algorithms',

      padding_no_change: 'Input already has a power-of-two number of digits: {n}.',
      padding_changed: 'Input padded to {n} digits: x={x}, y={y}.',
      status_ready: 'Prepared. Use Run step or Auto run.',
      status_running: 'Auto run is running...',
      status_paused: 'Auto run paused.',
      status_full: 'Full derivation and result shown instantly.',
      status_finished: 'Execution finished.',
      status_reset: 'Step state reset.',
      status_invalid: 'Please enter positive integer values.',
      status_compare_running: 'Operations comparison is running...',
      status_compare_done: 'Operations comparison finished.',
      status_compare_stopped: 'Operations comparison stopped.',

      comparison_title: 'Operations comparison',
      comparison_repeats_label: 'Repetitions',
      comparison_run_btn: 'Run comparison',
      comparison_stop_btn: 'Stop',
      comparison_progress_idle: 'Choose repetitions and run to build averages.',
      comparison_progress_running: 'Running sample {done}/{total}...',
      comparison_progress_done: 'Completed {done} samples.',
      comparison_progress_stopped: 'Stopped at sample {done}/{total}.',
      comparison_xmax_label: 'Max x length',
      comparison_yzoom_label: 'Y zoom',
      comparison_yzoom_value: '{value}x',
      comparison_toggle_classroom: 'Classroom curves',
      comparison_toggle_karatsuba: 'Karatsuba curves',
      comparison_toggle_total: 'Total operations',
      comparison_toggle_mul: 'Multiplications',
      comparison_toggle_add: 'Sums',
      comparison_toggle_theory: 'Theoretical n^2 and n^1.58',
      comparison_toggle_theory_n2: 'Theoretical n^2',
      comparison_toggle_theory_n158: 'Theoretical n^1.58',
      comparison_chart_title: 'Operation curves by input length',
      comparison_table_title: 'Average operations table',
      comparison_table_col_len: 'Length',
      comparison_table_col_total: 'Total',
      comparison_table_col_mul: 'Mul',
      comparison_table_col_add: 'Sum',
      comparison_chart_x: 'Input length',
      comparison_chart_y: 'Operations',
      comparison_series_class_total: 'Class total',
      comparison_series_class_mul: 'Class mul',
      comparison_series_class_add: 'Class sum',
      comparison_series_kara_total: 'Karatsuba total',
      comparison_series_kara_mul: 'Karatsuba mul',
      comparison_series_kara_add: 'Karatsuba sum',
      comparison_series_theory_n2: 'Theory n^2',
      comparison_series_theory_n158: 'Theory n^1.58',
      comparison_tip_length: 'Length {length}',
      comparison_tip_value: 'Value {value}',
      answer_egg_text: 'The Answer To Life, The Universe, And Everything',

      class_row_label_x: 'x',
      class_row_label_y: 'y',
      class_row_carry: 'carry',
      class_row_partial: 'partial with digit {digit}',
      class_row_result: 'result',

      power_x: 'x = {expr}',
      power_y: 'y = {expr}',
      power_product: 'x·y = Σᵢ Σⱼ (xᵢ·yⱼ)·10^(i+j)',

      drop_none: 'No dropped multiplication at base case.',
      drop_pending: 'Dropped products will appear when the corresponding Karatsuba step is executed.',
      drop_formula: 'Direct products {p1} and {p2} are not computed directly; they are replaced by (a+b)(c+d)-ac-bd.',
      tree_waiting: 'Recursive decomposition will appear as you execute steps.',

      step_class_prepare: 'Normalize input and split into digit arrays.',
      step_class_partial: 'Compute partial product for y digit {digit} with shift {shift}.',
      step_class_zero: 'Zero shortcut: one multiplication is enough because x·y = 0.',
      step_class_partial_digit: 'Compute one partial-product digit for y digit {digit} (position {pos}).',
      step_class_partial_zero: 'y digit is 0 at shift {shift}: partial product is 0 with one multiplication.',
      step_class_partial_carry: 'Emit final carry for partial product of y digit {digit}.',
      step_class_sum: 'Sum all partial products to obtain the final value.',
      step_class_done: 'Classroom multiplication finished.',

      step_kar_prepare: 'Normalize input and start Karatsuba recursion.',
      step_kar_zero: 'Zero shortcut: one multiplication is enough because x·y = 0.',
      step_kar_split: 'Split into a={a}, b={b}, c={c}, d={d}.',
      step_kar_pq: 'Compute p=a+b and q=c+d.',
      step_kar_rec_ac: 'Recurse for ac.',
      step_kar_rec_bd: 'Recurse for bd.',
      step_kar_rec_pq: 'Recurse for pq=(a+b)(c+d).',
      step_kar_drop: 'Drop direct ad and bc multiplications.',
      step_kar_combine: 'Combine: x·y = ac·10^(2m) + (pq-ac-bd)·10^m + bd.',
      step_kar_base: 'Base case: multiply one-digit numbers.',
      step_kar_done: 'Karatsuba multiplication finished.',

      tree_node_kind_root: 'root',
      tree_node_kind_ac: 'ac branch',
      tree_node_kind_bd: 'bd branch',
      tree_node_kind_pq: 'pq branch',
      node_return_pending: 'Return equation appears after combine.',
      node_return_base: 'return = {x} × {y} = {result}',
      node_middle_line: 'middle = {pq} - {ac} - {bd} = {middle}',
      node_return_line: 'return = {ac}·10^{pow} + {middle}·10^{m} + {bd} = {result}',
      node_drop_label: 'Dropped cross-products:'
    },

    pt: {
      app_title: 'Visualizador da Multiplicação de Karatsuba',
      app_subtitle: 'Compare o algoritmo escolar e Karatsuba passo a passo.',
      controls_title: 'Controles',
      mult_table_open: 'Abrir tabuada (0 a 9)',
      mult_table_title: 'Tabuada de multiplicação (0 a 9)',
      help_open: 'Abrir ajuda rápida',
      help_title: 'Como usar este visualizador',
      help_intro: 'Esta ferramenta compara a multiplicação escolar e a de Karatsuba passo a passo.',
      help_use_title: 'Como usar:',
      help_use_1: 'Informe dois inteiros (eles são preenchidos automaticamente para tamanhos potência de 2 quando necessário).',
      help_use_2: 'Use Executar passo, Auto executar ou Executar tudo para controlar a execução.',
      help_use_3: 'Alterne as abas para comparar os algoritmos; os contadores mostram multiplicações e somas de um dígito até o passo atual.',
      help_use_4: 'Use os botões de recolher painéis para liberar espaço e inspecionar a árvore de decomposição.',
      close_btn: 'Fechar',
      toggle_controls_hide: 'Recolher painel de controles',
      toggle_controls_show: 'Expandir painel de controles',
      toggle_code_hide: 'Recolher painel de algoritmo e log',
      toggle_code_show: 'Expandir painel de algoritmo e log',
      input_x_label: 'Primeiro número (x)',
      input_y_label: 'Segundo número (y)',
      random_length_label: 'Tamanho aleatório',
      random_btn: 'Aleatório',
      prepare_btn: 'Preparar',
      run_step_btn: 'Executar passo',
      auto_run_btn: 'Auto executar',
      run_full_btn: 'Executar tudo',
      speed_label: 'Velocidade',
      reset_btn: 'Reiniciar passos',
      metric_total: 'Total de operações (mult + soma)',
      metric_mul_small: 'Multiplicações',
      metric_add_small: 'Somas',
      metric_step: 'Passo atual',
      derivation_depth_label: 'Profundidade da derivação',
      derivation_depth_value: '{current} / {total}',
      tab_classroom: 'Algoritmo escolar',
      tab_karatsuba: 'Algoritmo de Karatsuba',
      tab_comparison: 'Comparação de operações',
      digits_grid_title: 'Grade de dígitos',
      powers_title: 'Reescrita em potências de 10',
      derivation_title: 'Derivação',
      karatsuba_identity_title: 'Identidade de Karatsuba',
      karatsuba_tree_title: 'Decomposição recursiva',
      dropped_title: 'Multiplicações diretas descartadas',
      code_title: 'Código do algoritmo',
      log_title: 'Log de passos',
      footer_repo: 'Repositório do projeto:',
      footer_license: 'Licença MIT',
      footer_references_link: 'Referências',
      footer_ai: 'Desenvolvido com assistência do GPT-5 Codex.',
      references_title: 'Referências',
      references_main_heading: 'Referências principais',
      references_main_1_author: 'Roughgarden, Tim.',
      references_main_1_title: 'Algorithms Illuminated: Part 1: The Basics.',
      references_main_1_pub: 'Soundlikeyourself Publishing, 2017.',
      references_main_2_author: 'Kleinberg, Jon; Tardos, Éva.',
      references_main_2_title: 'Algorithm Design.',
      references_main_2_pub: 'Addison-Wesley (Pearson), 2005.',
      references_other_heading: 'Outras referências',
      references_other_1_prefix: 'Youtube - ',
      references_other_1_title: 'The Fastest Multiplication Algorithm',
      references_other_2_prefix: 'Youtube - ',
      references_other_2_title: 'How a Russian student invented a faster multiplication method',
      references_other_3_prefix: 'Wikipedia - ',
      references_other_3_title: 'Ancient Egyptian multiplication',
      references_see_more_heading: 'Veja mais algoritmos',

      padding_no_change: 'A entrada já possui número de dígitos potência de 2: {n}.',
      padding_changed: 'Entrada preenchida para {n} dígitos: x={x}, y={y}.',
      status_ready: 'Preparado. Use Executar passo ou Auto executar.',
      status_running: 'Auto execução em andamento...',
      status_paused: 'Auto execução pausada.',
      status_full: 'Derivação completa e resultado mostrados instantaneamente.',
      status_finished: 'Execução finalizada.',
      status_reset: 'Estado dos passos reiniciado.',
      status_invalid: 'Informe valores inteiros positivos.',
      status_compare_running: 'Comparação de operações em execução...',
      status_compare_done: 'Comparação de operações finalizada.',
      status_compare_stopped: 'Comparação de operações interrompida.',

      comparison_title: 'Comparação de operações',
      comparison_repeats_label: 'Repetições',
      comparison_run_btn: 'Executar comparação',
      comparison_stop_btn: 'Parar',
      comparison_progress_idle: 'Escolha as repetições e execute para montar as médias.',
      comparison_progress_running: 'Executando amostra {done}/{total}...',
      comparison_progress_done: 'Concluídas {done} amostras.',
      comparison_progress_stopped: 'Interrompido na amostra {done}/{total}.',
      comparison_xmax_label: 'Tamanho máximo no eixo x',
      comparison_yzoom_label: 'Zoom em y',
      comparison_yzoom_value: '{value}x',
      comparison_toggle_classroom: 'Curvas do escolar',
      comparison_toggle_karatsuba: 'Curvas do Karatsuba',
      comparison_toggle_total: 'Operações totais',
      comparison_toggle_mul: 'Multiplicações',
      comparison_toggle_add: 'Somas',
      comparison_toggle_theory: 'Teóricas n^2 e n^1.58',
      comparison_toggle_theory_n2: 'Teórica n^2',
      comparison_toggle_theory_n158: 'Teórica n^1.58',
      comparison_chart_title: 'Curvas de operações por tamanho de entrada',
      comparison_table_title: 'Tabela de médias de operações',
      comparison_table_col_len: 'Tamanho',
      comparison_table_col_total: 'Total',
      comparison_table_col_mul: 'Mult',
      comparison_table_col_add: 'Soma',
      comparison_chart_x: 'Tamanho da entrada',
      comparison_chart_y: 'Operações',
      comparison_series_class_total: 'Escolar total',
      comparison_series_class_mul: 'Escolar mult',
      comparison_series_class_add: 'Escolar soma',
      comparison_series_kara_total: 'Karatsuba total',
      comparison_series_kara_mul: 'Karatsuba mult',
      comparison_series_kara_add: 'Karatsuba soma',
      comparison_series_theory_n2: 'Teoria n^2',
      comparison_series_theory_n158: 'Teoria n^1.58',
      comparison_tip_length: 'Tamanho {length}',
      comparison_tip_value: 'Valor {value}',
      answer_egg_text: 'The Answer To Life, The Universe, And Everything',

      class_row_label_x: 'x',
      class_row_label_y: 'y',
      class_row_carry: 'vai-um',
      class_row_partial: 'parcial com dígito {digit}',
      class_row_result: 'resultado',

      power_x: 'x = {expr}',
      power_y: 'y = {expr}',
      power_product: 'x·y = Σᵢ Σⱼ (xᵢ·yⱼ)·10^(i+j)',

      drop_none: 'Nenhuma multiplicação descartada no caso base.',
      drop_pending: 'Os produtos descartados aparecerão quando o passo correspondente de Karatsuba for executado.',
      drop_formula: 'Os produtos diretos {p1} e {p2} não são calculados diretamente; são substituídos por (a+b)(c+d)-ac-bd.',
      tree_waiting: 'A decomposição recursiva aparecerá conforme você executa os passos.',

      step_class_prepare: 'Normaliza a entrada e separa em vetores de dígitos.',
      step_class_partial: 'Calcula produto parcial para o dígito y={digit} com deslocamento {shift}.',
      step_class_zero: 'Atalho do zero: uma multiplicação é suficiente porque x·y = 0.',
      step_class_partial_digit: 'Calcula um dígito do produto parcial para o dígito y={digit} (posição {pos}).',
      step_class_partial_zero: 'Dígito y igual a 0 no deslocamento {shift}: produto parcial 0 com uma multiplicação.',
      step_class_partial_carry: 'Emite o carry final do produto parcial do dígito y={digit}.',
      step_class_sum: 'Soma todos os produtos parciais para obter o valor final.',
      step_class_done: 'Multiplicação escolar finalizada.',

      step_kar_prepare: 'Normaliza a entrada e inicia a recursão de Karatsuba.',
      step_kar_zero: 'Atalho do zero: uma multiplicação é suficiente porque x·y = 0.',
      step_kar_split: 'Divide em a={a}, b={b}, c={c}, d={d}.',
      step_kar_pq: 'Calcula p=a+b e q=c+d.',
      step_kar_rec_ac: 'Recursão para ac.',
      step_kar_rec_bd: 'Recursão para bd.',
      step_kar_rec_pq: 'Recursão para pq=(a+b)(c+d).',
      step_kar_drop: 'Descarta multiplicações diretas ad e bc.',
      step_kar_combine: 'Combina: x·y = ac·10^(2m) + (pq-ac-bd)·10^m + bd.',
      step_kar_base: 'Caso base: multiplica números de um dígito.',
      step_kar_done: 'Multiplicação de Karatsuba finalizada.',

      tree_node_kind_root: 'raiz',
      tree_node_kind_ac: 'ramo ac',
      tree_node_kind_bd: 'ramo bd',
      tree_node_kind_pq: 'ramo pq',
      node_return_pending: 'A equação de retorno aparece após a combinação.',
      node_return_base: 'retorno = {x} × {y} = {result}',
      node_middle_line: 'meio = {pq} - {ac} - {bd} = {middle}',
      node_return_line: 'retorno = {ac}·10^{pow} + {middle}·10^{m} + {bd} = {result}',
      node_drop_label: 'Produtos cruzados descartados:'
    }
  };

  function format(text, params) {
    return text.replace(/\{(\w+)\}/g, (_, key) => (params && params[key] !== undefined ? params[key] : `{${key}}`));
  }

  window.I18N = {
    messages,
    t(lang, key, params = {}) {
      const dict = messages[lang] || messages.en;
      const fallback = messages.en[key] || key;
      const template = dict[key] || fallback;
      return format(template, params);
    }
  };
})();
